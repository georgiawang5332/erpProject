<script>
  function converterDataParaDjangoFormat(data) {
    const dataJS = new Date(data);
    const ano = dataJS.getFullYear();
    const mes = (dataJS.getMonth() + 1).toString().padStart(2, '0');
    const dia = dataJS.getDate().toString().padStart(2, '0');
    const hora = dataJS.getHours().toString().padStart(2, '0');
    const minuto = dataJS.getMinutes().toString().padStart(2, '0');
    const segundo = dataJS.getSeconds().toString().padStart(2, '0');
    const formatoDjango = `${ano}-${mes}-${dia} ${hora}:${minuto}:${segundo}`;
    return formatoDjango;
  }
  document.addEventListener('DOMContentLoaded', function () {
    // 獲取三個 div 元素
    var calendarEl1 = document.getElementById('calendar1');
    var calendarEl2 = document.getElementById('calendar2');
    var calendarEl3 = document.getElementById('calendar3');
    // 獲取當前日期    
    var today = new Date();

    // 初始化第一個月份的 FullCalendar
    var calendar1 = new FullCalendar.Calendar(calendarEl1, {
      // 獲取當前日期
      initialDate: new Date(today.getFullYear(), today.getMonth() - 1, 1),
      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
      },
      // 其他配置選項
      locale: 'UTC',
      navLinks: true, // can click day/week names to navigate views
      selectable: true,
      selectMirror: true,
      select: function (arg) {
        console.log('clicked')
        console.log(arg.start)
        console.log(arg.end)
        var modal = document.getElementById('eventModal')
        modal.style.display = 'block'
        document.getElementById('id_start_time').value = converterDataParaDjangoFormat(arg.start);
        document.getElementById('id_end_time').value = converterDataParaDjangoFormat(arg.end);
        calendar1.unselect()
      },

      eventClick: function (arg) {
        console.log('clicked')
        var title = arg.event.title;
        var start = formatDateTime(arg.event.start);
        var end = formatDateTime(arg.event.end);
        var description = arg.event.extendedProps.description || '';
        var id = arg.event.id;

        var modalInputEnd = document.getElementById('end_event_detail');

        var modal = document.getElementById('detailModal')
        var modalTitle = document.getElementById('title_event_detail');
        var modalStart = document.getElementById('start_event_detail');
        var modalEnd = document.getElementById('end_event_detail');
        var modalDescripition = document.getElementById('description_event_detail');
        var deleteButton = document.getElementById("delete-event-button");
        var nextWeek = document.getElementById("add-to-next-week");
        var nextDay = document.getElementById("add-to-next-day");

        deleteButton.setAttribute("data-event-id", id);
        nextWeek.setAttribute("data-event-id-week", id);
        nextDay.setAttribute("data-event-id-day", id);
        modal.style.display = 'block'

        modalTitle.textContent = title;
        modalStart.textContent = start;
        modalEnd.textContent = end;
        modalDescripition.textContent = description;

        modal.style.display = 'block';
      },
      editable: true,
      dayMaxEvents: true, // allow "more" link when too many events
      events: [{'id': 1, 'title': 'dfjkhldfg', 'start': '2024-04-21T16:00:00', 'end': '2024-04-22T16:00:00', 'description': 'dkljflk'}, {'id': 2, 'title': '阿鳩玩店子雞', 'start': '2024-05-13T16:00:00', 'end': '2024-05-15T16:00:00', 'description': '晚上十點可以看遊戲'}],
    });

  // 初始化第二個月份的 FullCalendar
  var calendar2 = new FullCalendar.Calendar(calendarEl2, {
    headerToolbar: {
      left: 'prev,next',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
    },
    // 其他配置選項
    locale: 'UTC',
    initialDate: new Date(),
    navLinks: true, // can click day/week names to navigate views
    selectable: true,
    selectMirror: true,
    select: function (arg) {
      console.log('clicked')
      console.log(arg.start)
      console.log(arg.end)
      var modal = document.getElementById('eventModal')
      modal.style.display = 'block'
      document.getElementById('id_start_time').value = converterDataParaDjangoFormat(arg.start);
      document.getElementById('id_end_time').value = converterDataParaDjangoFormat(arg.end);
      calendar2.unselect()
    },

    eventClick: function (arg) {
      console.log('clicked')
      var title = arg.event.title;
      var start = formatDateTime(arg.event.start);
      var end = formatDateTime(arg.event.end);
      var description = arg.event.extendedProps.description || '';
      var id = arg.event.id;

      var modalInputEnd = document.getElementById('end_event_detail');

      var modal = document.getElementById('detailModal')
      var modalTitle = document.getElementById('title_event_detail');
      var modalStart = document.getElementById('start_event_detail');
      var modalEnd = document.getElementById('end_event_detail');
      var modalDescripition = document.getElementById('description_event_detail');
      var deleteButton = document.getElementById("delete-event-button");
      var nextWeek = document.getElementById("add-to-next-week");
      var nextDay = document.getElementById("add-to-next-day");

      deleteButton.setAttribute("data-event-id", id);
      nextWeek.setAttribute("data-event-id-week", id);
      nextDay.setAttribute("data-event-id-day", id);

      modal.style.display = 'block'
      modalTitle.textContent = title;
      modalStart.textContent = start;
      modalEnd.textContent = end;
      modalDescripition.textContent = description;
    },
    editable: true,
    dayMaxEvents: true, // allow "more" link when too many events
    events: [{'id': 1, 'title': 'dfjkhldfg', 'start': '2024-04-21T16:00:00', 'end': '2024-04-22T16:00:00', 'description': 'dkljflk'}, {'id': 2, 'title': '阿鳩玩店子雞', 'start': '2024-05-13T16:00:00', 'end': '2024-05-15T16:00:00', 'description': '晚上十點可以看遊戲'}],
    });

  // 初始化第三個月份的 FullCalendar
  var calendar3 = new FullCalendar.Calendar(calendarEl3, {
    headerToolbar: {
      left: 'prev,next',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,list'
    },
    // 其他配置選項
    locale: 'UTC',
    initialDate: new Date(today.getFullYear(), today.getMonth() + 1, 1), // 下下個月,
    navLinks: true, // can click day/week names to navigate views
    selectable: true,
    selectMirror: true,
    select: function (arg) {
      console.log('clicked')
      console.log(arg.start)
      console.log(arg.end)
      var modal = document.getElementById('eventModal')
      modal.style.display = 'block'
      document.getElementById('id_start_time').value = converterDataParaDjangoFormat(arg.start);
      document.getElementById('id_end_time').value = converterDataParaDjangoFormat(arg.end);
      calendar3.unselect()
    },

    eventClick: function (arg) {
      console.log('clicked')
      var title = arg.event.title;
      var start = formatDateTime(arg.event.start);
      var end = formatDateTime(arg.event.end);
      var description = arg.event.extendedProps.description || '';
      var id = arg.event.id;

      var modalInputEnd = document.getElementById('end_event_detail');

      var modal = document.getElementById('detailModal')
      var modalTitle = document.getElementById('title_event_detail');
      var modalStart = document.getElementById('start_event_detail');
      var modalEnd = document.getElementById('end_event_detail');
      var modalDescripition = document.getElementById('description_event_detail');
      var deleteButton = document.getElementById("delete-event-button");
      var nextWeek = document.getElementById("add-to-next-week");
      var nextDay = document.getElementById("add-to-next-day");

      deleteButton.setAttribute("data-event-id", id);
      nextWeek.setAttribute("data-event-id-week", id);
      nextDay.setAttribute("data-event-id-day", id);
      modal.style.display = 'block'

      modalTitle.textContent = title;
      modalStart.textContent = start;
      modalEnd.textContent = end;
      modalDescripition.textContent = description;
    },
    editable: true,
    dayMaxEvents: true, // allow "more" link when too many events
    events: [{'id': 1, 'title': 'dfjkhldfg', 'start': '2024-04-21T16:00:00', 'end': '2024-04-22T16:00:00', 'description': 'dkljflk'}, {'id': 2, 'title': '阿鳩玩店子雞', 'start': '2024-05-13T16:00:00', 'end': '2024-05-15T16:00:00', 'description': '晚上十點可以看遊戲'}],
    });

  // 渲染這三個月份的 FullCalendar
  calendar1.render();
  calendar2.render();
  calendar3.render();
  });

  const closeBtn1 = document.getElementById('modalClose1');
  const closeBtn2 = document.getElementById('modalClose2');
  const closeBtn3 = document.getElementById('modalDetailClose');
  closeBtn1.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn2.addEventListener('click', () => {
    const eventModal = document.getElementById('eventModal')
    eventModal.style.display = 'none';
  });
  closeBtn3.addEventListener('click', () => {
    const eventModal = document.getElementById('detailModal')
    eventModal.style.display = 'none';
  });
  function formatDateTime(dateTime) {
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
    const dataFormatada = new Date(dateTime).toLocaleDateString('pt-BR', options);
    return dataFormatada;
  };

  document.getElementById('delete-event-button').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id');
    console.log('eventId:', eventId);
    if (confirm('Are you sure you want to delete this event?')) {
      $.ajax({
        // 確保前端 AJAX 請求的 URL 與 Django 視圖的 URL 模式匹配。你可以修改前端的 URL 為 /calendarapp/delete_event/${eventId}/，以確保它與你的 Django 視圖相匹配。
        url: `/calendarapp/delete_event/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: 's5iwdHFizU5ORCYJm4HcXUwtRdEFNr6fyrNECO1q7HXUI3WMrGJFGuw6BgUtbtdW',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
          console.log('response:', response);
        },
        error: function (xhr, status, error) {
          console.log('XHR:', xhr);
          console.log('Status:', status);
          console.log('Error:', error);
          alert('Error!');
        }

      });
    }
  });

  document.getElementById('add-to-next-week').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-week');
    console.log('eventId:', eventId);

    if (confirm('您確定要將此活動加入下週嗎？')) {
      $.ajax({
        url: `/calendarapp/next_week/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: 's5iwdHFizU5ORCYJm4HcXUwtRdEFNr6fyrNECO1q7HXUI3WMrGJFGuw6BgUtbtdW',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

  document.getElementById('add-to-next-day').addEventListener('click', function () {
    const eventId = this.getAttribute('data-event-id-day');
    console.log('eventId:', eventId);

    if (confirm('您確定要將此活動新增至第二天嗎？')) {
      $.ajax({
        url: `/calendarapp/next_day/${eventId}/`,
        type: 'POST',
        data: {
          csrfmiddlewaretoken: 's5iwdHFizU5ORCYJm4HcXUwtRdEFNr6fyrNECO1q7HXUI3WMrGJFGuw6BgUtbtdW',
        },
        success: function (response) {
          alert(response.message);
          window.location.reload();
        },
        error: function (xhr, status, error) {
          alert('Error!');
        }
      });
    }
  });

</script>